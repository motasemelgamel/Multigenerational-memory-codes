clear all

%read data
Nt=20;
[delta1,epsilon1]=Vashistha(Nt,'..\ALL_LB37_Size','Expt1_0529');
[delta2,epsilon2]=Vashistha(Nt,'..\ALL_LB37_Size.xls','Expt2_050619');

delta=[delta2 delta1];
epsilon=[epsilon2 epsilon1];

k=1;
t_=(0:Nt-1);

Ip=((0.2)^2)/2;Is=((0.3)^2)/2;
am=@(beta,lambda) (lambda-beta+1-sqrt((beta-lambda-1).^2 -4*lambda))/2;ap=@(beta,lambda) (lambda-beta+1+sqrt((beta-lambda-1).^2 -4*lambda))/2;
ACFan=@(beta,lambda,t) (2./((am(beta,lambda)-ap(beta,lambda)).*(am(beta,lambda).*ap(beta,lambda) -1))).*((  am(beta,lambda).^(t).*(am(beta,lambda).*(Ip+Is)-(am(beta,lambda).^2 +1)*Is.*lambda +am(beta,lambda)*Is.*lambda.^2)  )./(am(beta,lambda).^2 -1)  +  ( (ap(beta,lambda)).^(t).*(Is*lambda + ap(beta,lambda).^(2)*Is.*lambda - ap(beta,lambda).*(Ip+Is+Is*lambda.^2)) )./(ap(beta,lambda).^2 -1));

for i=1:2:size(epsilon,2)-1
    clear epsilon1 epsilon2 delta1 delta2 A1 A2 A t1
    
    if length(epsilon{i}) == length(epsilon{i+1})
        epsilon1=(epsilon{i}-mean(epsilon{i}));
        epsilon2=(epsilon{i+1}-mean(epsilon{i+1}));
        elseif length(epsilon{i}) > length(epsilon{i+1})
        epsilon1=(epsilon{i}(1:length(epsilon{i+1}))-mean(epsilon{i}(1:length(epsilon{i+1}))));
        epsilon2=(epsilon{i+1}-mean(epsilon{i+1}));
        elseif length(epsilon{i}) < length(epsilon{i+1})
        epsilon1=(epsilon{i}-mean(epsilon{i}));
        epsilon2=(epsilon{i+1}(1:length(epsilon{i}))-mean(epsilon{i+1}(1:length(epsilon{i}))));
    end
    
    if length(delta{i}) == length(delta{i+1})
        delta1=(delta{i}-mean(delta{i}));
        delta2=(delta{i+1}-mean(delta{i+1}));
        elseif length(delta{i}) > length(delta{i+1})
        delta1=(delta{i}(1:length(delta{i+1}))-mean(delta{i}(1:length(delta{i+1}))));
        delta2=(delta{i+1}-mean(delta{i+1}));
        elseif length(delta{i}) < length(delta{i+1})
        delta1=(delta{i}-mean(delta{i}));
        delta2=(delta{i+1}(1:length(delta{i}))-mean(delta{i+1}(1:length(delta{i}))));
    end
        xs(k)=length(epsilon1);
        xs(k+1)=length(epsilon2);
        
     for n=1:length(epsilon1)
         A1(n)=mean((epsilon1(1:end-n+1)).*(epsilon1(n:end)))./mean((epsilon1(1:end)).*(epsilon1(1:end)));
         A2(n)=mean((epsilon2(1:end-n+1)).*(epsilon2(n:end)))./mean((epsilon2(1:end)).*(epsilon2(1:end)));
      end
        A=[A1' A2'];
        t1=(0:length(epsilon1)-1);
        fun1=@(x,t1) ACFan(x(2),x(1),t1)./ACFan(x(2),x(1),0);
        fun2=@(x,t1) ACFan(x(2),x(1),t1)./ACFan(x(2),x(1),0);
        fun=@(x,t1) [fun1(x,t1), fun2(x,t1)];
        options = optimoptions('lsqcurvefit','StepTolerance', 1e-16,'OptimalityTolerance', 1e-16, 'FunctionTolerance', 1e-16);
        x=lsqcurvefit(fun,[0.01,0.01],t1',A,[],[],options);
        lambda_(k)=x(1);
        beta_(k)=x(2);
        lambda_(k+1)=x(1);
        beta_(k+1)=x(2);
        Aindividual(:,k)= A1(1:Nt)';
        Aindividual(:,k+1)= A2(1:Nt)';
        k=k+2;
end


lambda1=real(lambda_);
beta1=real(beta_);
clear lambda_ beta_
ind=1;
for i=1:2:length(lambda1)
    lambda_(ind)=lambda1(i);
    beta_(ind)=beta1(i);
    xs1(ind)=xs(i);
    if xs(i)<30
       xs_37(ind)=xs(i);
    elseif xs(i)>=30 && xs(i)<=100
        xs_37(ind)=2*xs(i);
    else
        xs_37(ind)=3*xs(i);
    end
    ind=ind+1;
end

Nt=20;k=1;
[delta1,epsilon1]=Vashistha(Nt,'P:\Data\Vashistha 2021\ALL_LB37_Size','Expt1_0529');
[delta2,epsilon2]=Vashistha(Nt,'P:\Data\Vashistha 2021\ALL_LB37_Size.xls','Expt2_050619');
[delta3,epsilon3]=Vashistha(Nt,'P:\Data\Vashistha 2021\ALL_LB32_Size.xls','Expt1_1012');
[delta4,epsilon4]=Vashistha(Nt,'P:\Data\Vashistha 2021\ALL_LB32_Size.xls','Expt1_1015');
[delta5,epsilon5]=Vashistha(Nt,'P:\Data\Vashistha 2021\ALL_LB32_Size.xls','Expt3_2807');

epsilon=[epsilon5 epsilon4 epsilon3 epsilon2 epsilon1];

%fit single lineages
for i=1:size(epsilon,2)
    clear epsilon_ delta A t1
    
    epsilon_=(epsilon{i}-mean(epsilon{i}));
    xs_indv(k)=length(epsilon_);
        
        %ACF for individual lineages
     for n=1:length(epsilon_)
         A(n)=mean((epsilon_(1:end-n+1)).*(epsilon_(n:end)))./mean((epsilon_(1:end)).*(epsilon_(1:end)));
     end
        t1=(0:length(epsilon_)-1);
        fun=@(x,t1) ACFan(x(2),x(1),t1)./ACFan(x(2),x(1),0);
        options = optimoptions('lsqcurvefit','StepTolerance', 1e-16,'OptimalityTolerance', 1e-16, 'FunctionTolerance', 1e-16);
        x=lsqcurvefit(fun,[0.01,0.01],t1',A',[],[],options);
        lambda_indv(k)=x(1);
        beta_indv(k)=x(2);
        k=k+1;
end

r_fit=[0.993623488609717	0.415378671239979	0.503299626783572	0.343807045701929	0.801899594479636	0.223685923169291	0.497294533571060	0.538019069825705	0.820655593751760	0.785431529577808	0.596342803886706	0.259168321578907	0.994247347711842	0.806761497873208	0.744784757559019	0.784141252265503	0.163941746587520	0.929545785204258	1.00713790100549	0.781769680653146	0.947793278824666	0.916975616724441	0.552632490716649	0.733768979665839	0.933785943518745	0.788427735889679	0.0838062656634542	1.02395375260726	0.682055342647053	0.205817936672919	0.976215173241561	0.286876384011504	0.912868764121606	0.812619859516090	0.738483346016777	0.939928098639160	0.820636971237931	0.404208137639566	1.07538107561970	0.268623834123998	0.619716571324461	0.161088292971769	0.658040565115173	0.266884688996380	0.613459989428693	0.701230878821743	1.02835458751941	0.890918352070861	0.252550337927563	0.707177183769002	0.717210222070572	0.196582571527348	0.869517652430977	0.607375982429883	0.716224706191356	0.461169446490535	0.628103159976555	0.716687139967140	0.333235884149620	0.757735471662944	0.188615915846269	0.780264097242970	0.0992434571578480	0.819047418925277	0.904186205776409	0.636609536823203	0.257785441063480	0.354115375199652	0.249518709246860	0.781419361031089	0.744134331794503];
omega2_fit=[-0.437821638258055	0.201441813911999	0.244994421417876	0.0794132098501222	0.237862264050062	0.273629897116360	0.179756781859042	0.169272501022880	-0.137892021493310	-0.157539903973471	0.141778236262645	0.230966365461366	-0.135684606621467	-0.112854958850197	0.155762054968266	0.123005857520726	0.107131499877867	-0.0551152695898398	-0.0772135327661541	0.117003493052135	-0.244644404379978	-0.108961335675893	0.131058713928823	0.0498174163225149	-0.191798405875975	0.168671549888447	0.0676192589510599	0.0185087966110107	-0.00884256889889451	0.135063293511152	-0.198094416603009	0.374369157228841	-0.319155008590552	0.00492956776771425	0.0748326248327962	-0.208575413469536	-0.193059527025347	0.233335242071474	0.489028262877192	0.211336144842796	0.206608733355916	0.112259330386231	0.122754580038644	0.131389399624562	0.00562115734849727	0.113333004558291	-0.0780033253699194	0.112971971392407	0.190499238787275	0.0488852960712252	0.0824298563921637	0.171845621688074	-0.0474332115653213	0.193203279453918	-0.122788654302399	0.190830498382276	0.123536222441584	-0.0213778632394329	0.124710342096723	0.0884009065386675	0.111528803033862	0.00235333703181484	0.0696290567790815	-0.0219496582672843	-0.0264479708813953	0.0694730341599257	0.278891044020213	0.167307324448402	0.280925836027167	-0.117403610043537	0.00577670828409771];
xs_fit=[94	28	70	60	29	25	25	62	26	396	70	26	25	94	21	24	27	26	20	23	98	25	86	68	26	66	22	22	64	21	23	20	459	90	23	122	74	70	25	23	70	25	26	80	60	21	21	20	25	21	22	22	24	25	114	60	92	70	27	29	22	28	90	29	66	60	27	20	23	72	60];

se_r=[0.261183289274713	0.0643511924050055	0.119460957381530	0.0980283833286494	0.278134734944525	0.0213746302402792	0.140100050238935	0.269738834412082	0.361310328079072	0.404150065630086	0.165315605110567	0.0365025643450410	0.239605797384850	0.375452602362973	0.517562214314545	0.264352131938726	0.0160402894004244	0.452328309805030	0.160233255956591	0.167486438717382	0.176258244603825	0.200935316803825	0.126663082763808	0.476594268038206	0.177128871557965	0.184261180404211	0.0147201226260455	0.169170591709072	0.305232097984607	0.0304374143334271	0.238184101153348	0.0283251982330902	0.162696459411254	0.131816430765360	0.189895052012875	0.188353934730863	0.575722701467993	0.128836404223336	0.160740890089642	0.0250923945641035	0.117551702218495	0.0262703463856690	0.248471441016929	0.0461007812617317	0.262518492511942	0.251836269574682	0.401473871006644	0.202652327478507	0.0602410361987071	0.302686512857291	0.317039123692077	0.0632702782795615	0.809307518811218	0.146502566095600	0.315966571130154	0.134133931437033	0.176133480135325	0.304829978782155	0.0628355749306225	0.194491707627036	0.0242299331517436	0.265154695072291	0.0110100277570256	0.398196121393239	0.143494775741754	0.126311298162691	0.0239503691310298	0.0936641950278624	0.0185691366363470	0.307985223108462	0.201148259182985];
se_omega2=[0.463553409527490	0.0602703334482869	0.119687685647037	0.0770086085744616	0.314543362117932	0.0186127834401098	0.139783433328894	0.278575176459023	0.537067872792187	0.589526849298687	0.180170842491213	0.0314573491601209	0.370557691080123	0.545730282416893	0.612740910160539	0.325770665703137	0.0104711013569080	0.668612471003070	0.235465040519755	0.207144039557154	0.294565713884730	0.308535490808872	0.133392056378713	0.601109158762561	0.287282253501746	0.219467304079065	0.00687645079079617	0.226608403022804	0.381309374825332	0.0217386833250643	0.386538046460103	0.0273628134843306	0.277601174986643	0.179404243718211	0.236554102770409	0.308639794494887	0.876934700789891	0.121245654884192	0.167274859438168	0.0213488698988113	0.127026427684572	0.0171162067451803	0.285774598386313	0.0350685016308366	0.304720162953878	0.299506370918066	0.581197945955210	0.257811698737844	0.0496524971742093	0.374967861195863	0.387917650418915	0.0496791970893404	1.17321380944064	0.157978438790662	0.427087745857047	0.129987791146959	0.198132815310545	0.394644382615091	0.0511893371803262	0.242771558444932	0.0161224244345321	0.354777666954139	0.00578026559166591	0.553679642904082	0.206810003389117	0.146413889324451	0.0216423514862039	0.0814729707411906	0.0168060411166283	0.440037415257505	0.262168042207267];


r_fit_dyn=[0.876594537402570	0.830611280084238	0.847520692581117	0.690146477912330	0.847829819670830	0.856627910144867	0.812927755709595	0.588387208808623	0.792927463022746	0.739329722951402	0.793929835489781	0.888663555380562	0.938119760364691	0.818330088078404	0.874184189958015	0.784612651273316	0.755151001288249	0.894078469692489	0.917936888212527	0.863453716445771	0.774438686318870	0.945168345701575	0.721847227839152	0.669342828344323	0.891686411206421	0.730298133102895	0.864766319980872	0.940957277820391	0.830113269052194	0.783074679308501	0.768799029994533	0.928166589877862	0.800866169791448	0.813258422504656	0.836966584147721	0.903291844689646	0.750800284915990	0.744252067093086	0.927342135095642	0.803162434234419	0.833450353401972	0.738796419153752	0.795769946412988	0.774349743186328	0.714715177295629	0.818213379899271	0.968862313964738	0.935388989175048	0.948291411952990	0.810037573796124	0.588173942456737	0.806644149204220	0.777712678797065	0.899013336587692	0.799574509357766	0.583640491520722	0.837697948015401	0.771291923532559	0.883548958285585	0.794417307920338	0.685665227244392	0.730735822101302	0.746898766467532	0.930603588272992	0.691321941655114	0.716371505471054	0.472495291290215	0.705028767125492	0.875722723713018	0.781687498438833	0.765481142061538];
omega2_fit_dyn=[-0.156799112453611	-0.114378644444178	0.198440491363785	-0.0975725791825430	0.105517416322176	-0.0548024220563241	-0.0519971716177883	0.187733606669394	-0.159554899448140	-0.0119663087063490	0.126461455143061	-0.0578208179554245	-0.0468185422398841	-0.140103447123576	-0.0258867425740971	0.226408576912368	-0.0333291938361624	0.150153930284008	0.151370541442944	0.147147834587060	0.0324827546416016	0.0692343246407061	0.0119884260378107	0.171073786088227	-0.0521017848249908	0.268600442274806	-0.173026434296480	0.0750386873303565	-0.183335971963363	0.00652075198624458	0.0743867369022315	-0.105738045951060	-0.0906924250926520	-0.00556846146643986	0.163840455136563	-0.0567952883715079	-0.0259884287330293	0.0118897136689214	0.0249148407902694	-0.00683339690570173	0.00124642527618535	-0.0675405303667498	-0.0859899275664683	-0.0106961109654738	-0.0395671250263360	-0.0374864051470689	-0.00970512711130767	0.213915961824628	-0.0833848597990458	-0.0154626808108217	0.0640168865222703	-0.124687511732038	-0.0945914309574242	-0.0480224257732044	-0.111103027164371	0.224475645648190	-0.107857080508631	-0.0258664003915974	-0.215596449733158	-0.0808863622412970	-0.136105986965913	0.0895791506768701	-0.0441975705632423	-0.131733510902790	0.0194539472791371	-0.00645692872726911	-0.0502093523861190	0.0614969714275802	0.0162866825147954	-0.0730958372026669	-0.0161953195088285];
xs_fit_dyn=[94	28	70	60	29	25	25	62	26	396	70	26	25	94	21	24	27	26	20	23	98	25	86	68	26	66	22	22	64	21	23	20	459	90	23	122	74	70	25	23	70	25	26	80	60	21	21	20	25	21	22	22	24	25	114	60	92	70	27	29	22	28	90	29	66	60	27	20	23	72	60];

se_r_dyn=[0.0562147989824057	0.0756146143582023	0.0632986696704665	0.0761108139722383	0.0693958684232755	0.0740049687692050	0.0815079433153319	0.0797330346928462	0.0959290203258734	0.0352157877477664	0.0634457651939921	0.0849119888633067	0.0984705551348895	0.0641669319745355	0.0910790674776260	0.0939767603251651	0.0856883147075508	0.0867170036241530	0.108445980082362	0.0935879352699831	0.0622322091930673	0.104466649897594	0.0608176414444915	0.0821379996646273	0.101676099795443	0.0840813607164923	0.0927446203074088	0.0995096904953739	0.0673443774423160	0.0832756979188149	0.100351634657186	0.0798171489151306	0.0336763889888434	0.0669693511583627	0.0805842767431507	0.0520233174310350	0.0675619378626980	0.0787192743563362	0.143553269281403	0.0872483323434789	0.0736251137896581	0.0749621708220482	0.0939940257117469	0.0603332977949568	0.0690951281856425	0.0877889665369372	0.0921619557171594	0.110795648166705	0.0841630899425629	0.0954553547502601	0.0790338620663428	0.0870202951974958	0.104893104260496	0.103029530361310	0.0524067965875029	0.0675054445538703	0.0615082585652505	0.0753917896565329	0.0770175668028070	0.101466832407956	0.100677335301279	0.0740672873450996	0.0604415571201461	0.0649284737025987	0.0850272344296013	0.0799758409625359	0.119613034214783	0.101824666564628	0.0946207507276146	0.0731544084951715	0.0729689722912445];
se_omega2_dyn=[0.0706474485317939	0.0942880230481950	0.0719338420563090	0.0874972338221724	0.0819971163329358	0.0920355584454262	0.0986826700131337	0.0815617194653422	0.109576910733944	0.0405898410350773	0.0727951317923348	0.100032613006999	0.113861127216364	0.0768020739968763	0.112420464340472	0.100785742357092	0.0986408170154687	0.0977077787694439	0.123978114061139	0.111787633664124	0.0711181232732315	0.115525374276542	0.0694943104770780	0.0861915705000008	0.113451542756415	0.0909506781439766	0.113390099583433	0.117524962001495	0.0849052927725382	0.0998419630409285	0.110257886839352	0.103836949009454	0.0401263120581919	0.0778120432751361	0.0926303800709879	0.0640422633636546	0.0780663738118618	0.0873767757713098	0.143458615286215	0.103704264140690	0.0865155792703568	0.0903483095040375	0.109885607449789	0.0727143069367648	0.0820672308903191	0.107562599263975	0.111842347170262	0.129336556488854	0.103911284093335	0.110967050582051	0.0845386287164871	0.103665074452023	0.118033769091273	0.119333931164127	0.0637513098495582	0.0700208910568810	0.0757212316647483	0.0870419886023483	0.0975018536960893	0.114538023815588	0.114725174709613	0.0846962305985728	0.0704853246106359	0.0820384655134141	0.0948792161421668	0.0905255098237974	0.118540104525566	0.110184210699288	0.107603054588835	0.0861103599782772	0.0872717901456827];



beta_fit=[0.552715125961902	0.376229581137801	0.511570195619732	0.197762081946002	0.865584493969760	0.324077576581977	0.433122371154702	0.464944118285045	0.527969379873447	0.455340232869487	0.496087467561333	0.297087885938359	0.786400087533864	0.535130334904072	0.713302649010320	0.736514580024568	0.127252429054310	0.799909070417400	0.937833233376097	0.722063552015695	0.648711446161561	0.723391412730089	0.434842443339411	0.564209350714630	0.669199488775003	0.784066888244406	0.0746490471125877	1.06597416140428	0.456102469953467	0.163973046016802	0.739996728407412	0.462034794956527	0.507456616869828	0.666314520860185	0.620443098848206	0.670814866047460	0.485729001655847	0.392404681373001	1.61788765779671	0.281179496027666	0.588687788601167	0.131824036493770	0.558170981678433	0.145458994283531	0.379307279061296	0.603162356565870	0.977431848412670	0.903106128532660	0.253986101264216	0.546635758694686	0.593636084051957	0.210444023064674	0.706870257649972	0.562366191220130	0.387197438749781	0.407263854517751	0.514208659102829	0.493351194456156	0.237824525495251	0.658494302742277	0.142398973768700	0.606398356396784	0.0814391177571461	0.649935991802346	0.775425191259574	0.460116114419219	0.344410825706618	0.293533569090235	0.343598910356329	0.492040079516234	0.555119272518670];
lambda_fit=[-0.428449478204863	0.542625925675159	0.449678705957438	0.519188776293434	0.268624740369965	0.848313022420195	0.395961851141382	0.380390026864363	-0.119758237570311	-0.130968723113141	0.289369912215999	0.778057995249940	-0.206301358109021	-0.0771863616756712	0.226079261978811	0.174532390293543	0.823568227228713	-0.0618842129650270	-0.0756329253428041	0.165745558836938	-0.256125650490645	-0.134877075400857	0.320456112064386	0.0832130061865503	-0.181023911344918	0.203296911517615	0.906179656436724	0.0210512112710374	0.0654728032911143	0.810169758036060	-0.212670590987369	0.905034018755992	-0.327159035571261	0.0122674328996904	0.148972345430792	-0.209949649910430	-0.132989452241434	0.584901997415102	0.481477320804952	0.746187173620982	0.352701089360347	0.845071764432175	0.238561645013020	0.798666901212710	0.166841140046328	0.204025935224277	-0.0793927476291479	0.138839591417307	0.766170334428625	0.131095451352588	0.149039333424786	0.835620131768572	-0.0370256940397018	0.347417041963900	-0.0439719970484061	0.491920317549850	0.265636443834935	0.0665221233767542	0.569129693536079	0.143240635269639	0.789972433306812	0.0513595938025277	0.886755347085538	-0.00584964030136836	-0.0461082570362587	0.216072045874165	0.826558193473551	0.586842647986638	0.843901877568873	-0.0743885909719732	0.0689698984100923];

se_lambda=[0.466525794772293	0.109489413950476	0.191478485011445	0.184387858347888	0.379139335570399	0.0369604513167586	0.236092012160843	0.451336709243892	0.650829846919376	0.745727010548908	0.275731889850470	0.0633917286623457	0.372697639163607	0.671647314537021	0.790155460312047	0.404759595866204	0.0301195254249773	0.718079373374020	0.233791065506722	0.258183671189954	0.310655561421746	0.335877145952077	0.216845687351268	0.796932265133728	0.307399760926284	0.270108970949037	0.0285873069649755	0.221226222526167	0.543926702244027	0.0562970441476189	0.395903169994463	0.0455230922834760	0.303894859363714	0.218116157402744	0.310866491934897	0.328152388211908	1.06427660442983	0.215142317463499	0.154287891138293	0.0438897947873478	0.184408627962947	0.0493355168333649	0.408671445048444	0.0846293138781491	0.477164842801939	0.408194526668664	0.564953701606483	0.287251966022219	0.106794921651045	0.513310567895939	0.521900998099710	0.113864771745774	1.34242791371367	0.233639845002920	0.589431666446191	0.226896276654805	0.293656864302358	0.539013066606418	0.114869697237031	0.311624948826050	0.0454436720154179	0.447578014194273	0.0211932950116094	0.669242775810708	0.227977836057707	0.218211491289455	0.0405258062757724	0.165600553031444	0.0314143908283289	0.558409786824802	0.345060912602415];
se_beta=[0.234990478950775	0.0676488883025097	0.142897414713382	0.0666286233235669	0.407049244384363	0.0214807893266555	0.150906123473013	0.295518747372901	0.314008157641372	0.311833814608040	0.182452520102572	0.0362110142395233	0.301231177542420	0.335780451128000	0.668682982648546	0.340143893369300	0.0110443526008369	0.550241413326074	0.219181484042411	0.213419822293531	0.166616317691357	0.220650286615045	0.130966003291240	0.522941057956170	0.176079344444644	0.250698771893014	0.00703519161029252	0.255995536804048	0.277146670819400	0.0231600428639475	0.264928941713149	0.0337181774229504	0.116311934349574	0.148079801319211	0.218180079998109	0.184999537905406	0.439479038414482	0.141806415402232	0.282038617276677	0.0243351386551856	0.145832330814144	0.0180701736482220	0.282736410824877	0.0365924495529042	0.219037778560618	0.295064832013089	0.570571986208025	0.285933858341739	0.0557743173756788	0.320918620757937	0.360103557311345	0.0552025924171618	0.904324021852700	0.176817505687063	0.227837237688341	0.143128354602449	0.194570443147027	0.284868702887596	0.0509724490692807	0.232804614670507	0.0168294775886531	0.284432716974382	0.00597721435058106	0.431688210860171	0.174324722650432	0.127286767746727	0.0255370270734260	0.0875693014506213	0.0198087705464600	0.259996347264642	0.206822279465655];

beta_dyn=[0.611618870550414	0.575536454158999	0.916731815716961	0.378729581792251	0.824332819445248	0.679008954382839	0.608854364385251	0.533933114158996	0.469179062167548	0.534642130533047	0.756786038823891	0.731902096706196	0.833250142546822	0.529560685930832	0.738311255398453	0.842025589450509	0.536923840910483	0.949530240251671	0.993978672184242	0.892700155031073	0.632238033508899	0.962577526356958	0.533051846376880	0.619093607944205	0.743002871105195	0.801935805488380	0.574794353876780	0.960439286013518	0.505752067493158	0.619726705360356	0.665438685422767	0.755755172614440	0.550694196823772	0.655820800308322	0.864353518116466	0.759140868311315	0.537712639096902	0.565800853041253	0.884878276314013	0.638236498859656	0.695885916862058	0.478279618587656	0.547259880047661	0.588921413807259	0.471250659630386	0.631986729899119	0.928989056309798	1.08886852289455	0.815871742184750	0.640698190150690	0.409965473107371	0.525987271713361	0.510245579804282	0.760202553589331	0.528216368850341	0.565111868990739	0.593880771600584	0.569024830914958	0.565062311954385	0.550212496882101	0.334030816886191	0.623553992378936	0.513660196787479	0.734289527603778	0.497379974292935	0.506731205123595	0.173042447905306	0.558562533902071	0.783176971342142	0.537939508012893	0.569766059343008];
lambda_dyn=[-0.141570204254725	-0.0856861060094779	0.221690430554728	-0.00156337403240874	0.128673180103589	-0.0342468659068957	-0.0170011470339395	0.357158696541751	-0.116675863877944	0.0559826846302441	0.168926367844330	-0.0454250140549273	-0.0429893781825610	-0.107099490225975	-0.0100571245175763	0.272800286903878	0.0266218383339847	0.161373300866693	0.158104895759187	0.165792722139532	0.0833606608711585	0.0722408349538081	0.0893573906985753	0.280407951255559	-0.0403699513076463	0.341339539282590	-0.154738286084964	0.0785247303727349	-0.154474470611230	0.0535773467433544	0.127840625433700	-0.100578007141284	-0.0510381427591233	0.0293039552990096	0.190420349821026	-0.0474428210679762	0.0361120692649225	0.0772967188550809	0.0301940061227292	0.0319116303908176	0.0289852100581132	0.000686780280152981	-0.0442800127783146	0.0402219274346020	0.0418203050391288	-0.00444002989942200	-0.00873557161967707	0.218090544544450	-0.0807110817212303	0.0206230425584412	0.233617588193898	-0.0873010266950778	-0.0451797777898471	-0.0378241195860536	-0.0709326498651903	0.397830885949296	-0.0815151244302195	0.0264409838498394	-0.202035604616786	-0.0386221189585760	-0.0372996376025937	0.162082348176332	0.0198626638524144	-0.126917648942206	0.114736090982706	0.0739881941814875	0.228051865324877	0.148504999651088	0.0317315239161062	-0.0254354888647722	0.0388037752199320];

se_lambda_dyn=[0.0798184999359194	0.111591793331663	0.0831187724470315	0.119504592741032	0.0949935385017664	0.106040282299190	0.118633811553946	0.115149673580463	0.133420002106767	0.0523238534032781	0.0886068078852944	0.111414018846754	0.120937811281056	0.0917119194948114	0.127224308003906	0.122334756994698	0.124966942474649	0.108095563220870	0.134199949397377	0.127642700986622	0.0881976150165014	0.121830012239942	0.0911304361436611	0.114991157311267	0.125742858322475	0.116161553229620	0.129466352550146	0.124518864610354	0.100627098966217	0.123700395753486	0.136410856466018	0.111523405168636	0.0487530483770718	0.0930889759400816	0.108200474209951	0.0704229488167486	0.0994451664903660	0.110950239906682	0.153526399036208	0.125664527664335	0.101595373831484	0.117815741251010	0.133868407709554	0.0910220433727080	0.109837977139557	0.128757346711647	0.115344266889797	0.137749562264709	0.109354983992195	0.133181544073146	0.128441230509020	0.125204477877641	0.145492931768484	0.131537572473158	0.0777610430020743	0.102076890066468	0.0888773035149638	0.108496863647291	0.109423541710495	0.139009506098240	0.157025435987278	0.109986653855940	0.0903629600396084	0.0878673720421433	0.127769174647066	0.119083885413010	0.184517322668682	0.144246357605141	0.121128546427129	0.106540190758663	0.110174137476371];
se_beta_dyn=[0.0791796789997835	0.102066406222528	0.0954890359942017	0.0942872012940609	0.101189791282499	0.103258898599744	0.111804284578742	0.110317632133922	0.137871718639312	0.0471468046829813	0.0908311294688292	0.128168248077691	0.155434380742617	0.0897691732092699	0.130367026441900	0.142691040909730	0.117274090907663	0.135627077245542	0.170389248386855	0.136901962722358	0.0878212511275021	0.169736772329751	0.0805629297614545	0.117318530914092	0.159815051416771	0.121594384866366	0.132833436834342	0.155253877137058	0.0895279154566645	0.111523896748159	0.147220516748464	0.114217508042124	0.0464708185343713	0.0963017057829990	0.119448566394111	0.0765918436001805	0.0914828981436183	0.111700227776859	0.242610406381283	0.121068214134728	0.106588036562278	0.0927187107917849	0.131980138260690	0.0792175164437551	0.0838580093601771	0.119369829732100	0.143774143788450	0.173573502317036	0.127965582524312	0.136782949669484	0.0921317302443387	0.120888236915030	0.151135899411836	0.158613377537196	0.0702787984066687	0.0883642953461460	0.0850522686753732	0.104709686128652	0.108412687931030	0.147845965551789	0.126042515947873	0.0992309840333146	0.0802948489089536	0.0956145999301558	0.112221033630033	0.106787493582350	0.152257904397273	0.143756875319549	0.145396771331005	0.100276905029131	0.0957055019332709];

r_fit_37=(1+beta_-lambda_)./2;omega2_fit_37=beta_-r_fit_37.^2;
r_fit_indv=(1+beta_indv-lambda_indv)./2;omega2_fit_indv=beta_indv-r_fit_indv.^2;

%r is on the x-axis, omega^2 is on the y-axis
start=-2;lim=2;step=0.001;
omega2=(lim:-step:start)'*ones(1,length(start:step:lim));
r=((start:step:lim)'*ones(1,length(start:step:lim)))';
b=-omega2;c=1-r;
a1=c -sqrt(b);a2=c +sqrt(b);


figure(1)
clf
subplot(1,2,1)
hold on
beta=(0:0.001:1);
plot([0 0],[-1 1],'linewidth',1.5,'color','k')
plot([0 4],[1 1],'linewidth',1.5,'color','k')
lambda=beta-1;
plot(beta,lambda,'linewidth',1.5,'color','k')
beta=(0:0.001:4);
lambda=0.5*beta-1;
plot(beta,lambda,'linewidth',1.5,'color','k')
lambda=(0:0.001:1);
beta=lambda+1+sqrt(4*lambda);
plot(beta,lambda,'linewidth',1.5,'color','k')
beta=lambda+1-sqrt(4*lambda);
plot(beta,lambda,'linewidth',1.5,'color','k')
scatter(beta_fit,lambda_fit,xs_fit,'Ob','linewidth',1.5)
h1=errorbar(beta_fit,lambda_fit,se_lambda,se_lambda,se_beta,se_beta,'blue','LineWidth',1.5);
scatter(beta_dyn,lambda_dyn,xs_fit_dyn,'Oy','linewidth',1.5)
h2=errorbar(beta_dyn,lambda_dyn,se_lambda_dyn,se_lambda_dyn,se_beta_dyn,se_beta_dyn,'yellow','LineWidth',1.5);
xlabel('$\beta$','interpreter','latex')
ylabel('$\lambda$','interpreter','latex')
ylim([-1,1.1])
set(gca,'FontSize',36)
pbaspect([1 1 1])
legend([h1 h2],'ACF fit','Dynamics fit')
h1.LineStyle='none';h2.LineStyle='none';
box on

subplot(1,2,2)
hold on
r=(0:0.01:2);
plot(r,1-(1-r).^2,r,r.*0,[1 1],[-1 0],'linewidth',1.5,'color','k')
r=(0:0.01:1);
plot(r,-(r).^2,'linewidth',1.5,'color','k')
r=(1:0.01:2);
plot(r,-(r-2).^2,'linewidth',1.5,'color','k')
p(1)=scatter(r_fit,omega2_fit,xs_fit,'Ob','linewidth',1.5)
p(3)=scatter(r_fit_dyn,omega2_fit_dyn,xs_fit_dyn,'Oy','linewidth',1.5)
p(4)=scatter(r_fit_indv,omega2_fit_indv,xs_indv,'MarkerEdgeColor', [.5 .5 .5],'linewidth',1.5)
p(2)=scatter(r_fit_37,omega2_fit_37,xs_37,'Oc','linewidth',1.5)
xlabel('$r$','interpreter','latex')
ylabel('$\omega^2$','interpreter','latex')
xlim([0,2])
ylim([-1,1.3])
set(gca,'FontSize',36)
pbaspect([1 1 1])
%Set legends to the plot
legend(p(1:4),'LB 32','LB 37','Dynamics fit','Relaxed-sister-constraint')
box on

function [delta,epsilon]=Vashistha(N,file,sheet_name)
%give the function file name with path
data=xlsread(file,sheet_name);

%extract lineage data into arrays
k=1;
for i=2:4:size(data,2)
    T(:,k)=data(:,i-1);
    T(:,k+1)=data(:,i-1);
    x(:,k)=data(:,i);
    x(:,k+1)=data(:,i+1);
    k=k+2;
end

%initialize birth size xn
xn(1,:)=x(1,:);
Tb(1,:)=T(1,:);

%Finding xn (birth size) of each generation and growth rate
for i=1:size(x,2)
    k=2;
    for j=3:size(x,1) 
        %Finding xn and Tn
        if ((x(j-1,i)>x(j-2,i) && x(j,i)<x(j-1,i)) && x(j,i)~=0 && x(j-1,i)~=0 && (abs(round(x(j-1,i)-x(j,i)))~=0))
            xn(k,i)=x(j,i);
            Tb(k,i)=T(j,i);Td(k-1,i)=T(j-1,i);
            xd(k-1,i)=x(j-1,i);
            k=k+1; %Update indecies
        end
    end
end

%Calculating phi_n and storing separate lineage data in cell arrays
for i=1:size(xn,2)
    xngen{:,i}=xn(xn(:,i)~=0,i);
    xdgen{:,i}=xd(xd(:,i)~=0,i);
    Tbgen{:,i}=Tb(Tb(2:end,i)~=0,i);
    Tdgen{:,i}=Td(Td(:,i)~=0,i);
    Tgen{:,i}=abs(Tdgen{:,i}-Tbgen{:,i});
    phigen{:,i}=log(xdgen{:,i}./xngen{:,i}(1:end-1,:));
    alpha_{:,i}=phigen{:,i}./Tgen{:,i};
end

%N is Lineage Length
k=1;
for j=1:2:size(xngen,2)-1
    if (length(xngen{j})>=N && length(xngen{j+1})>=N)
    epsilon{k}=log(xngen{j}(1:end)/mean(xngen{j}));
    epsilon{k+1}=log(xngen{j+1}(1:end)/mean(xngen{j+1}));
    delta{k}=(phigen{j}-mean(phigen{j}));
    delta{k+1}=(phigen{j+1}-mean(phigen{j+1}));
    phi{k}=phigen{j};
    phi{k+1}=phigen{j+1};
    k=k+2;
    end
end
end
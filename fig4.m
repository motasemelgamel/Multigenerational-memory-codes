clear all

%read experimental data
Pdata = xlsread('P:\Data\Vashistha 2021\Figure4data.xls');
tdata = Pdata(:,1);
PCFdata = Pdata(:,2);
PCFstd = Pdata(:,3);

Adata = xlsread('P:\Data\Vashistha 2021\Figure4data.xls',3);
Atdata= Adata(:,1);
ACFdata= Adata(:,2);
ACFstd= Adata(:,3);

% fitted values of r and omega^2 using ACF
r_fit=[0.993623488609717	0.415378671239979	0.503299626783572	0.343807045701929	0.801899594479636	0.223685923169291	0.497294533571060	0.538019069825705	0.820655593751760	0.785431529577808	0.596342803886706	0.259168321578907	0.994247347711842	0.806761497873208	0.744784757559019	0.784141252265503	0.163941746587520	0.929545785204258	1.00713790100549	0.781769680653146	0.947793278824666	0.916975616724441	0.552632490716649	0.733768979665839	0.933785943518745	0.788427735889679	0.0838062656634542	1.02395375260726	0.682055342647053	0.205817936672919	0.976215173241561	0.286876384011504	0.912868764121606	0.812619859516090	0.738483346016777	0.939928098639160	0.820636971237931	0.404208137639566	1.07538107561970	0.268623834123998	0.619716571324461	0.161088292971769	0.658040565115173	0.266884688996380	0.613459989428693	0.701230878821743	1.02835458751941	0.890918352070861	0.252550337927563	0.707177183769002	0.717210222070572	0.196582571527348	0.869517652430977	0.607375982429883	0.716224706191356	0.461169446490535	0.628103159976555	0.716687139967140	0.333235884149620	0.757735471662944	0.188615915846269	0.780264097242970	0.0992434571578480	0.819047418925277	0.904186205776409	0.636609536823203	0.257785441063480	0.354115375199652	0.249518709246860	0.781419361031089	0.744134331794503];
omega2_fit=[-0.437821638258055	0.201441813911999	0.244994421417876	0.0794132098501222	0.237862264050062	0.273629897116360	0.179756781859042	0.169272501022880	-0.137892021493310	-0.157539903973471	0.141778236262645	0.230966365461366	-0.135684606621467	-0.112854958850197	0.155762054968266	0.123005857520726	0.107131499877867	-0.0551152695898398	-0.0772135327661541	0.117003493052135	-0.244644404379978	-0.108961335675893	0.131058713928823	0.0498174163225149	-0.191798405875975	0.168671549888447	0.0676192589510599	0.0185087966110107	-0.00884256889889451	0.135063293511152	-0.198094416603009	0.374369157228841	-0.319155008590552	0.00492956776771425	0.0748326248327962	-0.208575413469536	-0.193059527025347	0.233335242071474	0.489028262877192	0.211336144842796	0.206608733355916	0.112259330386231	0.122754580038644	0.131389399624562	0.00562115734849727	0.113333004558291	-0.0780033253699194	0.112971971392407	0.190499238787275	0.0488852960712252	0.0824298563921637	0.171845621688074	-0.0474332115653213	0.193203279453918	-0.122788654302399	0.190830498382276	0.123536222441584	-0.0213778632394329	0.124710342096723	0.0884009065386675	0.111528803033862	0.00235333703181484	0.0696290567790815	-0.0219496582672843	-0.0264479708813953	0.0694730341599257	0.278891044020213	0.167307324448402	0.280925836027167	-0.117403610043537	0.00577670828409771];

% fitted lineages length
xs_fit=[94	28	70	60	29	25	25	62	26	396	70	26	25	94	21	24	27	26	20	23	98	25	86	68	26	66	22	22	64	21	23	20	459	90	23	122	74	70	25	23	70	25	26	80	60	21	21	20	25	21	22	22	24	25	114	60	92	70	27	29	22	28	90	29	66	60	27	20	23	72	60];

% standard error
se_r=[0.261183289274713	0.0643511924050055	0.119460957381530	0.0980283833286494	0.278134734944525	0.0213746302402792	0.140100050238935	0.269738834412082	0.361310328079072	0.404150065630086	0.165315605110567	0.0365025643450410	0.239605797384850	0.375452602362973	0.517562214314545	0.264352131938726	0.0160402894004244	0.452328309805030	0.160233255956591	0.167486438717382	0.176258244603825	0.200935316803825	0.126663082763808	0.476594268038206	0.177128871557965	0.184261180404211	0.0147201226260455	0.169170591709072	0.305232097984607	0.0304374143334271	0.238184101153348	0.0283251982330902	0.162696459411254	0.131816430765360	0.189895052012875	0.188353934730863	0.575722701467993	0.128836404223336	0.160740890089642	0.0250923945641035	0.117551702218495	0.0262703463856690	0.248471441016929	0.0461007812617317	0.262518492511942	0.251836269574682	0.401473871006644	0.202652327478507	0.0602410361987071	0.302686512857291	0.317039123692077	0.0632702782795615	0.809307518811218	0.146502566095600	0.315966571130154	0.134133931437033	0.176133480135325	0.304829978782155	0.0628355749306225	0.194491707627036	0.0242299331517436	0.265154695072291	0.0110100277570256	0.398196121393239	0.143494775741754	0.126311298162691	0.0239503691310298	0.0936641950278624	0.0185691366363470	0.307985223108462	0.201148259182985];
se_omega2=[0.463553409527490	0.0602703334482869	0.119687685647037	0.0770086085744616	0.314543362117932	0.0186127834401098	0.139783433328894	0.278575176459023	0.537067872792187	0.589526849298687	0.180170842491213	0.0314573491601209	0.370557691080123	0.545730282416893	0.612740910160539	0.325770665703137	0.0104711013569080	0.668612471003070	0.235465040519755	0.207144039557154	0.294565713884730	0.308535490808872	0.133392056378713	0.601109158762561	0.287282253501746	0.219467304079065	0.00687645079079617	0.226608403022804	0.381309374825332	0.0217386833250643	0.386538046460103	0.0273628134843306	0.277601174986643	0.179404243718211	0.236554102770409	0.308639794494887	0.876934700789891	0.121245654884192	0.167274859438168	0.0213488698988113	0.127026427684572	0.0171162067451803	0.285774598386313	0.0350685016308366	0.304720162953878	0.299506370918066	0.581197945955210	0.257811698737844	0.0496524971742093	0.374967861195863	0.387917650418915	0.0496791970893404	1.17321380944064	0.157978438790662	0.427087745857047	0.129987791146959	0.198132815310545	0.394644382615091	0.0511893371803262	0.242771558444932	0.0161224244345321	0.354777666954139	0.00578026559166591	0.553679642904082	0.206810003389117	0.146413889324451	0.0216423514862039	0.0814729707411906	0.0168060411166283	0.440037415257505	0.262168042207267];

% fitted values of r and omega^2 using data
r_fit_dyn=[0.876594537402570	0.830611280084238	0.847520692581117	0.690146477912330	0.847829819670830	0.856627910144867	0.812927755709595	0.588387208808623	0.792927463022746	0.739329722951402	0.793929835489781	0.888663555380562	0.938119760364691	0.818330088078404	0.874184189958015	0.784612651273316	0.755151001288249	0.894078469692489	0.917936888212527	0.863453716445771	0.774438686318870	0.945168345701575	0.721847227839152	0.669342828344323	0.891686411206421	0.730298133102895	0.864766319980872	0.940957277820391	0.830113269052194	0.783074679308501	0.768799029994533	0.928166589877862	0.800866169791448	0.813258422504656	0.836966584147721	0.903291844689646	0.750800284915990	0.744252067093086	0.927342135095642	0.803162434234419	0.833450353401972	0.738796419153752	0.795769946412988	0.774349743186328	0.714715177295629	0.818213379899271	0.968862313964738	0.935388989175048	0.948291411952990	0.810037573796124	0.588173942456737	0.806644149204220	0.777712678797065	0.899013336587692	0.799574509357766	0.583640491520722	0.837697948015401	0.771291923532559	0.883548958285585	0.794417307920338	0.685665227244392	0.730735822101302	0.746898766467532	0.930603588272992	0.691321941655114	0.716371505471054	0.472495291290215	0.705028767125492	0.875722723713018	0.781687498438833	0.765481142061538];
omega2_fit_dyn=[-0.156799112453611	-0.114378644444178	0.198440491363785	-0.0975725791825430	0.105517416322176	-0.0548024220563241	-0.0519971716177883	0.187733606669394	-0.159554899448140	-0.0119663087063490	0.126461455143061	-0.0578208179554245	-0.0468185422398841	-0.140103447123576	-0.0258867425740971	0.226408576912368	-0.0333291938361624	0.150153930284008	0.151370541442944	0.147147834587060	0.0324827546416016	0.0692343246407061	0.0119884260378107	0.171073786088227	-0.0521017848249908	0.268600442274806	-0.173026434296480	0.0750386873303565	-0.183335971963363	0.00652075198624458	0.0743867369022315	-0.105738045951060	-0.0906924250926520	-0.00556846146643986	0.163840455136563	-0.0567952883715079	-0.0259884287330293	0.0118897136689214	0.0249148407902694	-0.00683339690570173	0.00124642527618535	-0.0675405303667498	-0.0859899275664683	-0.0106961109654738	-0.0395671250263360	-0.0374864051470689	-0.00970512711130767	0.213915961824628	-0.0833848597990458	-0.0154626808108217	0.0640168865222703	-0.124687511732038	-0.0945914309574242	-0.0480224257732044	-0.111103027164371	0.224475645648190	-0.107857080508631	-0.0258664003915974	-0.215596449733158	-0.0808863622412970	-0.136105986965913	0.0895791506768701	-0.0441975705632423	-0.131733510902790	0.0194539472791371	-0.00645692872726911	-0.0502093523861190	0.0614969714275802	0.0162866825147954	-0.0730958372026669	-0.0161953195088285];

% lineage length
xs_fit_dyn=[94	28	70	60	29	25	25	62	26	396	70	26	25	94	21	24	27	26	20	23	98	25	86	68	26	66	22	22	64	21	23	20	459	90	23	122	74	70	25	23	70	25	26	80	60	21	21	20	25	21	22	22	24	25	114	60	92	70	27	29	22	28	90	29	66	60	27	20	23	72	60];

% standard error
se_r_dyn=[0.0562147989824057	0.0756146143582023	0.0632986696704665	0.0761108139722383	0.0693958684232755	0.0740049687692050	0.0815079433153319	0.0797330346928462	0.0959290203258734	0.0352157877477664	0.0634457651939921	0.0849119888633067	0.0984705551348895	0.0641669319745355	0.0910790674776260	0.0939767603251651	0.0856883147075508	0.0867170036241530	0.108445980082362	0.0935879352699831	0.0622322091930673	0.104466649897594	0.0608176414444915	0.0821379996646273	0.101676099795443	0.0840813607164923	0.0927446203074088	0.0995096904953739	0.0673443774423160	0.0832756979188149	0.100351634657186	0.0798171489151306	0.0336763889888434	0.0669693511583627	0.0805842767431507	0.0520233174310350	0.0675619378626980	0.0787192743563362	0.143553269281403	0.0872483323434789	0.0736251137896581	0.0749621708220482	0.0939940257117469	0.0603332977949568	0.0690951281856425	0.0877889665369372	0.0921619557171594	0.110795648166705	0.0841630899425629	0.0954553547502601	0.0790338620663428	0.0870202951974958	0.104893104260496	0.103029530361310	0.0524067965875029	0.0675054445538703	0.0615082585652505	0.0753917896565329	0.0770175668028070	0.101466832407956	0.100677335301279	0.0740672873450996	0.0604415571201461	0.0649284737025987	0.0850272344296013	0.0799758409625359	0.119613034214783	0.101824666564628	0.0946207507276146	0.0731544084951715	0.0729689722912445];
se_omega2_dyn=[0.0706474485317939	0.0942880230481950	0.0719338420563090	0.0874972338221724	0.0819971163329358	0.0920355584454262	0.0986826700131337	0.0815617194653422	0.109576910733944	0.0405898410350773	0.0727951317923348	0.100032613006999	0.113861127216364	0.0768020739968763	0.112420464340472	0.100785742357092	0.0986408170154687	0.0977077787694439	0.123978114061139	0.111787633664124	0.0711181232732315	0.115525374276542	0.0694943104770780	0.0861915705000008	0.113451542756415	0.0909506781439766	0.113390099583433	0.117524962001495	0.0849052927725382	0.0998419630409285	0.110257886839352	0.103836949009454	0.0401263120581919	0.0778120432751361	0.0926303800709879	0.0640422633636546	0.0780663738118618	0.0873767757713098	0.143458615286215	0.103704264140690	0.0865155792703568	0.0903483095040375	0.109885607449789	0.0727143069367648	0.0820672308903191	0.107562599263975	0.111842347170262	0.129336556488854	0.103911284093335	0.110967050582051	0.0845386287164871	0.103665074452023	0.118033769091273	0.119333931164127	0.0637513098495582	0.0700208910568810	0.0757212316647483	0.0870419886023483	0.0975018536960893	0.114538023815588	0.114725174709613	0.0846962305985728	0.0704853246106359	0.0820384655134141	0.0948792161421668	0.0905255098237974	0.118540104525566	0.110184210699288	0.107603054588835	0.0861103599782772	0.0872717901456827];

Ip=((0.2)^2)/2;Is=((0.3)^2)/2; %noise strengths
t_=(0:20);q=1;q_uni=1;

% sample points in phase space and calculate average PCF
for k=1:10000

    r=2*rand;omega2=-1 + 2*rand;
    beta=r^2 + omega2;
    lambda=1+ beta - 2*r;

    b=((-1+beta-lambda).^2 -4*lambda)./4;c=1/2 - beta./2 + lambda./2;

    if (abs(c -sqrt(b))<1 & abs(c +sqrt(b))<1 & b<0) || (abs(c -sqrt(b))<1 & abs(c +sqrt(b))<1 & b>0 & c>=0)
        r_uni(q_uni)=r;omega2_uni(q_uni)=omega2;
        am=(lambda-beta+1-sqrt((beta-lambda-1)^2 -4*lambda))/2;ap=(lambda-beta+1+sqrt((beta-lambda-1)^2 -4*lambda))/2;
        varan=-2*(Ip*(1+ ap*am) + Is*(lambda^2 *(ap*am + 1)-2*lambda*(ap+am)+ am*ap +1))/((am^2 -1)*(ap^2 -1)*(am*ap -1));
        epsilon02=varan;delta02=-2*(2*Ip*(ap-1)*(am-1) + Is*beta^2 *(am*ap+1))/((am^2 -1)*(ap^2 -1)*(am*ap -1));epsilon0delta0=2*(Ip*(ap-1)*(am-1) + Is*beta*(-lambda*(ap + am) + am*ap +1))/((am^2 -1)*(ap^2 -1)*(am*ap -1));
        PCFan=delta02*((am.^t_ - ap.^t_)./(am - ap)).^2 + epsilon02*((am.^t_ *(am+beta-lambda) - ap.^t_ *(ap+beta-lambda))./(am-ap)).^2 + 2*epsilon0delta0*((am.^t_ - ap.^t_)./(am-ap)).*((am.^t_ * (am+beta-lambda) - ap.^t_ *(ap+beta-lambda))./(am-ap));
    
        PCFannorm=PCFan/varan;
        ACFan=(2/((am-ap)*(am*ap -1))).*((  am.^(t_)*(am*(Ip+Is)-(am^2 +1)*Is*lambda +am*Is*lambda^2)  )./(am^2 -1)  +  ( (ap).^(t_)*(Is*lambda + ap^(2)*Is*lambda - ap*(Ip+Is+Is*lambda^2)) )./(ap^2 -1));
        ACFnorm=ACFan/ACFan(1);
    
        Aall_uni(q_uni,:)=ACFnorm;
        Pall_uni(q_uni,:)=PCFannorm;
        q_uni=q_uni+1;
    end
end

    Pav_uni=mean(Pall_uni);
    Aav_uni=mean(Aall_uni);

    figure(1)
    clf
    subplot(1,2,1)
    hold on

    % plot stability phase space
    r=(0.5:0.01:1.5);
    p=plot(r,-(r-1).^2,'linewidth',1.5,'color', [.5 .5 .5]);
    r=(0:0.01:2);
    plot(r,1-(1-r).^2,r,r.*0,[1 1],[-1 0],'linewidth',1.5,'color','k')
    r=(0:0.01:1);
    plot(r,-(r).^2,'linewidth',1.5,'color','k')
    r=(1:0.01:2);
    plot(r,-(r-2).^2,'linewidth',1.5,'color','k')

    % plot ACF and PCF
    alpha = 0.1;  
    scatter(r_fit,omega2_fit,xs_fit,'Ob','linewidth',1.5)
    h1=errorbar(r_fit,omega2_fit,se_omega2,se_omega2,se_r,se_r,'blue','LineWidth',1.5);
    scatter(r_fit_dyn,omega2_fit_dyn,xs_fit_dyn,'Oy','linewidth',1.5)
    h2=errorbar(r_fit_dyn,omega2_fit_dyn,se_omega2_dyn,se_omega2_dyn,se_r_dyn,se_r_dyn,'yellow','LineWidth',1.5);
    h1.LineStyle='none';h2.LineStyle='none';
    box on
    set(gca,'YDir','normal')
    xlabel('$r$','interpreter','latex')
    ylabel('$\omega^2$','interpreter','latex')
    legend([p h1 h2],'Standard model','ACF fit','Dyn fit');
    xlim([0,2])
    ylim([-1,1.3])
    set(gca,'FontSize',36)
    pbaspect([1 1 1])

    subplot(1,2,2)
    hold on
    p(3)=plot(t_,Pav_uni,'linestyle','--','color','m','LineWidth',2);
    p(4)=plot(t_,Aav_uni,'color','m','LineWidth',2);
    p(5)=errorbar(Atdata,ACFdata,ACFstd,'Ok','MarkerEdgeColor','k','MarkerFaceColor','k','LineWidth',1.5,'MarkerSize',10);
    p(6)=errorbar(tdata,PCFdata,PCFstd,'^g','MarkerEdgeColor','g','MarkerFaceColor','g','LineWidth',1.5,'MarkerSize',10);
    p(7)=plot(t_,0*t_,'k');
    xlim([0,12])
    ylim([-0.3,1])
    xlabel('Generation (n)','interpreter','latex')
    ylabel('Correlations','interpreter','latex')
    set(gca,'FontSize',36)
    pbaspect([1 1 1])
    legend(p(5:6),'ACF exp','PCF exp');